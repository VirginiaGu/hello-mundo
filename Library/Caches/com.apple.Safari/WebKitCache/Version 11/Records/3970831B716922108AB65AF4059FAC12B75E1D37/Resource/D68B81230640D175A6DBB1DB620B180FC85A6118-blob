webpackJsonp([345],{3923:function(e,i){(function(){"use strict";TS.registerModule("web.invite",{onStart:function i(){a=true;window.$CVO=window.$CVO||[];window.dataLayer=window.dataLayer||[];window.onpopstate=function(e){if(e.state){C(e.state.step,true)}};n=TS.web.invite.should_show_single_page_exp;t=TS.web.invite.account_type==="restricted"||TS.web.invite.account_type==="ultra_restricted";if(TS.web.invite.shared_invite_email){e="shared_invites";C("shared_invite_email");return}if(TS.web.invite.sso_required||TS.web.invite.sso_suggested&&TS.web.invite.domain_match){e="sso"}else if(TS.web.invite.invite_type==="whitelisted_domain"){e="whitelisted_domain"}else{e="admin_invites"}if(e==="sso")return C("sso");if(n)return C("single_page");C("name")}});var e;var i;var t;var n;var a;var r;var s;var o;var l;var u;var v;var m;var f;var c;var d;var p;var w;var b;var S;var h;var g;var T;var k=3;var y=0;var C=function t(n,a){var r=le[n];if(!r){TS.error("step not found")}if(!a){P(n)}i=n;TS.clog.track("GROWTH_JOIN_TEAM",{action:"enter_step",step:n,trigger:e});return r().then(function(){$("#invite_form").attr("data-step",n)})};var P=function e(i){if(!history||!history.pushState||!history.replaceState)return;if(a){a=false;history.replaceState({step:i},"","");return}history.pushState({step:i},"","")};var x=function e(){return TS.signup.suggestUsernameFromEmail(TS.web.invite.email).then(function(e){var i=f||e.username;var n={team_name:TS.web.invite.team_name,username_prefill:i,first_name:w||TS.web.invite.first_name_prefill,last_name:b||TS.web.invite.last_name_prefill};if(t){n.collect_guest_user_role=true}$("#invite_form").html(TS.templates.invite_single_page_form(n));var a=$("#username_container");var r=$("#names_container");var o=$("#password_container");var l=$("#invite_username");var u=$("#invite_first_name");var _=$("#invite_password");var c=$("#submit_btn");L(r);if(!$("body").hasClass("mobile"))u.focus();u.val(u.val());if(i){X(l,a).then(function(){if(!s){l.focus().val(l.val())}})}ie(a);O(r);q(o,{validate_immediately:true});c.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);return X(l,a).then(function(){return se(_,o)}).then(function(){if(!s||!m||!v){c.addClass("disabled");TS.ui.stopButtonSpinner(c.get(0),false);return}if(g==="other"){g=$("#other_current_role_input").val().trim()}S=document.getElementById("email_misc").checked;return C("user_tos")})});return Promise.resolve()})};var B=function e(){var i=TS.templates.invite_sso_form({team_name:TS.web.invite.team_name,invite_code:TS.web.invite.invite_code,sso_required:TS.web.invite.sso_required,sso_suggested:TS.web.invite.sso_suggested,auth_mode:TS.web.invite.auth_mode,email_domain:TS.web.invite.email_domain,allowed_domains_count:TS.web.invite.allowed_domains_count,google_sso_domain:TS.web.invite.google_sso_domain,auth_url:TS.web.invite.auth_url,saml_provider_label:TS.web.invite.saml_provider_label,domain_match:TS.web.invite.domain_match,invite_sso_url:TS.boot_data.invite_sso_url});$("#invite_form").html(i);$("#no_sso_btn").on("click",function(){C("name")});return Promise.resolve()};var E=function e(){var i=f||TS.web.invite.username_prefill;var t=c||TS.web.invite.real_name_prefill;var n;if(TS.boot_data.feature_name_tagging_client){n=TS.templates.invite_name_form({team_name:TS.web.invite.team_name,display_name_placeholder_prefill:TS.web.invite.real_name_prefill,real_name:c||TS.web.invite.real_name_prefill,uncheck_email:TS.web.invite.uncheck_email,custom_username_policy:TS.web.invite.username_policy})}else{n=TS.templates.invite_name_form({team_name:TS.web.invite.team_name,username_prefill:i,first_name:w||TS.web.invite.first_name_prefill,last_name:b||TS.web.invite.last_name_prefill,uncheck_email:TS.web.invite.uncheck_email,custom_username_policy:TS.web.invite.username_policy})}$("#invite_form").html(n);var a=$("#invite_username");var r=$("#invite_real_name");var o=$("#invite_display_name");var l=$("#invite_first_name");var u=$("#username_container");var _=$("#names_container");var v=$("#submit_btn");if(!TS.boot_data.feature_name_tagging_client)L(_);if(!$("body").hasClass("mobile"))l.focus();l.val(l.val());if(i){X(a,u).then(function(){if(!s){a.focus().val(a.val())}})}if(t&&TS.boot_data.feature_name_tagging_client){$("#submit_btn").toggleClass("disabled",false)}if(TS.boot_data.feature_name_tagging_client){I(_)}else{ie(u);O(_)}v.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);if(!TS.boot_data.feature_name_tagging_client){return X(a,u).then(function(){if(!s||!m){v.addClass("disabled");TS.ui.stopButtonSpinner(v.get(0),false);return}S=document.getElementById("email_misc").checked;return C("password")})}if(TS.boot_data.feature_name_tagging_client){var i=[{field:"real_name",text:r.val().trim()},{field:"display_name",text:o.val().trim()}];return Y(i)}});return Promise.resolve()};var I=function e(i){i.on("focusout",function(){Q()});i.on("input",function(){clearTimeout(u);u=setTimeout(function(){Q()},1500)})};var O=function e(i){i.on("focusout",function(){L(i);Q()})};var L=function e(i){m=true;i.find("input").each(function(){var e=$(this).val().trim();var i=$(this).closest(".name_field");var t=z(e,i);i.toggleClass("error",!t);if(!t){m=false}});if(m){w=$("#invite_first_name").val().trim();b=$("#invite_last_name").val().trim()}};var z=function e(i,t){t=t||$("");var n=t.find(".error_message");if(i.toLocaleLowerCase()==="slackbot"){n.html(TS.i18n.t("Sorry, slackbot is a reserved word. Try something else!","invite")());return false}return true};var U=function e(){if(window.load_zxcvbn_script)load_zxcvbn_script();var i=TS.templates.invite_password_form({team_name:TS.web.invite.team_name});$("#invite_form").html(i);$(".fs_split_pane_left").scrollTop(0);var n=$("#invite_password");var a=$("#password_container");var r=$("#submit_btn");q(a);if(!$("body").hasClass("mobile"))n.focus();r.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);return se(n,a).then(function(){if(!v){r.addClass("disabled");TS.ui.stopButtonSpinner(r.get(0),false);return}if(t){return C("guest_user_role")}return C("user_tos")})});return Promise.resolve()};var A=function e(){if(window.load_zxcvbn_script)load_zxcvbn_script();var i=TS.templates.invite_guest_user_role_form({team_name:TS.web.invite.team_name});$("#invite_form").html(i);$(".fs_split_pane_left").scrollTop(0);var t=$("#invite_guest_user_role");var n=$("#guest_user_role_container");var a=$("#submit_btn");J(n);if(!$("body").hasClass("mobile"))t.focus();a.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);return Promise.resolve().then(function(){h=t.val().trim();if(!h){a.addClass("disabled");TS.ui.stopButtonSpinner(a.get(0),false);return}return C("user_tos")})});return Promise.resolve()};var D=function e(){var i={terms_of_service:new Handlebars.SafeString(TS.templates.invite_user_tos_content({abs_root_url:TS.boot_data.abs_root_url})),show_header_illustration:n,should_show_single_page:n,abs_root_url:TS.boot_data.abs_root_url};var t=TS.templates.invite_tos_form(i);$("#invite_form").html(t);$(".fs_split_pane_left").scrollTop(0);$("#invite_form").find(".tos_contents").find("a").attr("target","_blank");var a=$("#submit_btn");if(!$("body").hasClass("mobile"))a.focus();if(n){j()}a.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);window.dataLayer.push({event:"AcknowledgeTOS"});Z()});return Promise.resolve()};var j=function e(){var i=$("#page");if(bowser&&!bowser.msie&&!bowser.msedge){i.on("scroll",function(){$(".tos_i_agree_banner").css("bottom",-i.scrollTop())})}i.scrollTop(0)};var q=function e(i,t){var n=i.find("input");n.on("input",function(){v=false;i.removeClass("error");Q()});if(t&&t.validate_immediately){n.on("focusout",function(){se(n,i)})}};var J=function e(i){var t=i.find("input");t.on("input",function(){i.removeClass("error");Q()})};var N=function e(i,t){var n=TS.templates.invite_joiner_invites({current_users:t.current_users});$("#invite_form").html(n).attr("data-step","user_invite");var a=$("#invite_form_body");var r=a.find("#invite_rows");var s=$("#submit_btn");var o=k;_.times(o,function(){V(r)});var l=r.find("input");l.filter(function(){return this.value===""}).first().focus();W(r,s);a.find("#invite_rows").on("click",'[data-action="admin_invites_delete_row"]',function(){M(a,$(this).closest(".invite_row"))});a.find('[data-action="signup_add_invite"]').on("click",function(){V(r)});$("#secondary_btn").on("click",function(){window.dataLayer.push({event:"SkipInvite"});window.location=i.url});s.on("click",function(e){e.preventDefault();TS.ui.startButtonSpinner(this);window.dataLayer.push({event:"SendInvite"});var t=true;r.find(".invite_row").each(function(){var e=$(this).find('[name="email_address"]').val().trim();if(e&&!TS.utility.email_regex.test(e)){t=false;return false}});var n=R();if(t)return F(n,"manual",i);TS.ui.stopButtonSpinner(s.get(0),false)});r.on("keydown","input",function(e){if(e.keyCode===TS.utility.keymap.enter){var i=r.find("input");var t=i.index($(e.currentTarget));var n=t+1;if(n<i.length){e.preventDefault();i.get(n).focus()}}});return Promise.resolve()};var V=function e(i){var t=$(TS.templates.create_invite_row());i.append(t);t.find("input").focus()};var M=function e(i,t){if(!t||!t.length)return;t.slideToggle(100,function(){t.remove();if($(".invite_row").length===0){V(i)}})};var W=function e(i,t){i.find("input").each(function(){H($(this),t)});i.on("focusout","input",function(){H($(this),t)})};var H=function e(i,t){var n=i.val().trim();var a=i.closest(".invite_row");if(!n)return;if(!TS.utility.email_regex.test(n)){var r=TS.i18n.t("Oops! That looks like an invalid email address!","team_creation")();a.addClass("error").find(".error_message").text(r);TS.utility.disableElement(t,true);y+=1;i.one("input remove",function(){a.removeClass("error");y-=1;if(!y){TS.utility.disableElement(t,false)}});return}a.find(".input_checkmark").removeClass("hidden");$(this).one("input",function(){a.find(".input_checkmark").addClass("hidden")})};var R=function e(){var i=[];$("#invite_form_body").find("#invite_rows").find(".invite_row").each(function(){var e=$(this).find('[name="email_address"]').val().trim();if(e){i.push({email:e,type:"regular"})}});return i};var F=function e(i,t,n){t=t||"manual";var a=false;var r=function e(i){if(a)return;a=true;window.location=i};if(!i.length)return r(n.url);var s={token:n.api_token,invites:JSON.stringify(i),source:"joiner",mode:t};window.callSlackAPIUnauthed("users.admin.inviteBulk",s,function(e){if(e){r(n.url)}else{$("#invite_failed_alert").removeClass("hidden");setTimeout(r(n.url),5e3)}})};var G=function e(){var i=TS.templates.shared_invite_email_form({team_name:TS.web.invite.team_name,crumb_key:TS.web.invite.crumb_key});$("#invite_form").html(i);Ladda.bind("#submit_btn");return Promise.resolve()};var Z=function e(){if(TS.web.invite.invite_type==="whitelisted_domain")return K();var n=$("#submit_btn");var a=false;var s=function e(i){if(a)return;a=true;window.location=i};var o;var l;if(TS.boot_data.feature_name_tagging_client){o=c;l=d}else{o=JSON.stringify({first_name:w,last_name:b});l=""}var u={code:TS.web.invite.invite_code,invite_type:TS.web.invite.invite_type,team:TS.web.invite.encoded_team_id,tz:TS.web.invite.tz,password:p,username:f,emailok:S,real_name:o,display_name:l};u.last_tos_acknowledged="tos_oct2016";if(t){if(h)u.title=h}if(TS.boot_data.feature_localization){u.locale=TS.i18n.locale()}window.callSlackAPIUnauthed("signup.createUser",u,function(e,t){r=null;if(e){window.$CVO.push(["trackEvent",{type:"invite",cb:function e(){s(t.url)},id:t.user_id+"-"+TS.web.invite.team_id,amount:"1"}]);window.dataLayer.push({event:"AcceptedInvite",teamid:TS.web.invite.team_id,teaminfo_current_role:g||"",teaminfo_current_role_is_manager:T||""});var a={token:t.api_token};window.callSlackAPIUnauthed("signup.getInviteInfo",a,function(e,i){if(e&&i.allow_joiner_invites===true){$("#invite_form").html("");N(t,i)}else{setTimeout(function(){s(t.url)},2e3)}});return}switch(t.error){case"invite_missing":r="invalid";break;case"invite_code_mismatch":r="invalid";break;case"invite_wrong_team":r="invalid";break;case"invite_already_accepted":r="accepted";break;case"invite_revoked":r="revoked";break;case"user_already_exists":r="accepted";break;case"error_failed":r="unknown";break;case"error_username_taken":if(i==="password"){p="";C("name");return}if($("#username").length&&$("#username_container").length){X($("#username"),$("#username_container"))}break;case"ratelimited":$("#ratelimit_alert").removeClass("hidden");break;default:r="unknown";break}if(r){C("error")}TS.ui.stopButtonSpinner(n.get(0),false)})};var K=function e(){var i=$("#signup_whitelisted_domain_form");i.find("input[name=tz]").val(TS.web.invite.tz);i.find("input[name=username]").val(f);i.find("input[name=password]").val(p);i.find("input[name=emailok]").val(S);i.find("input[name=real_name]").val(JSON.stringify({first_name:w,last_name:b}));if(TS.boot_data.feature_localization){i.find("input[name=locale]").val(TS.i18n.locale())}i.submit()};var Q=function e(){var t;var n;var a;var r;switch(i){case"name":if(TS.boot_data.feature_name_tagging_client){a=$("#invite_real_name").val()||"";t=!a||false}else{n=$("#invite_username").val()||"";t=!TS.signup.checkUsernameSyntax(n).is_valid||$("#username_container").hasClass("error")||!m}break;case"password":r=$("#invite_password").val()||"";t=!TS.utility.password.hasValidSyntax(r)||$("#password_container").hasClass("error");break;case"guest_user_role":var s=$("#invite_guest_user_role").val().trim()||"";t=!s||!TS.ui.validation.validate($("#invite_guest_user_role"));break;case"single_page":n=$("#invite_username").val()||"";r=$("#invite_password").val()||"";t=!TS.utility.password.hasValidSyntax(r)||$("#password_container").hasClass("error")||!TS.signup.checkUsernameSyntax(n).is_valid||$("#username_container").hasClass("error")||!m;break;default:return}$("#submit_btn").toggleClass("disabled",t)};var X=function e(i,t){var n=i.val().trim();return te(t).then(function(){n=i.val().trim();return ne(n,t)}).then(function(){Q();if(s){f=n}})};var Y=function e(i){var t=[];i.forEach(function(e){t.push(ee(e))});Promise.all(t).then(function(){c=$("#invite_real_name").val().trim();d=$("#invite_display_name").val().trim();return C("password")}).catch(function(){var e=$("#submit_btn");e.addClass("disabled");TS.ui.stopButtonSpinner(e.get(0),false)})};var ee=function e(i){return new Promise(function(e,t){window.callSlackAPIUnauthed("users.validateName",i,function(i,n,a){var r=a.field;if(!i){if(n.error==="invalid_name_specials"){n.error="name_invalid_name_specials"}if(n.error==="invalid_name_maxlength"){n.error="name_invalid_name_maxlength"}if(n.error==="invalid_name_required"){n.error="name_invalid_name_required"}var s=TS.ui.validation.getErrorMessage(n.error,{maxlength:80});var o=$("#invite_form_body");if(r==="real_name"){TS.ui.validation.showWarning(o.find('input[name="'+r+'"]'),s,{custom_for:"real_name_profile_field_warnings",should_truncate:false})}else if(r==="display_name"){TS.ui.validation.showWarning(o.find('input[name="'+r+'"]'),s,{custom_for:"display_name_profile_field_warnings",should_truncate:false})}t(new Error(n.error))}else{e(n)}})})};var ie=function e(i){i=i||$("");var t=i.find("input");t.on("input",function(){s=false;i.removeClass("error");Q();this.value=this.value.toLowerCase();clearTimeout(l);l=setTimeout(function(){X(t,i)},1500)});t.on("focusout",function(){X(t,i)})};var te=function e(i){i=i||$("");var t=i.find("input");var n=i.find(".input_overlay");if(o)return Promise.resolve();o=true;var a;var r;if(t.is(":focus")){r=TS.utility.getCursorPosition(t).start}var s=t.val().trim();var l=s;var u={};var _=TS.web.invite.diacritics||{};var v="/["+Object.keys(_).join()+"]/g";u[v]=function(e){return _[e]};u["/[A-Z]/g"]=function(e){return e.toLowerCase()};var m;var f;var c;Object.keys(u).forEach(function(e){c=u[e];m=e.split("/");f=new RegExp(m[1],m[2]);if(f.test(s)){a=true;s=s.replace(f,c);l=l.replace(f,function(e){return'<span class="seafoam_green">'+c(e)+"</span>"})}});if(a){n.html(l).addClass("show");return new Promise(function(e){setTimeout(function(){t.val(s);n.val(l);n.removeClass("show");if(r){t.setCursorPosition(r)}setTimeout(function(){o=false;e()},500)},300)})}o=false;return Promise.resolve()};var ne=function e(i){i=i||$("#invite_username").val().trim();if(!ae(i)){return Promise.resolve()}return re(i)};var ae=function e(i){i=i||$("#invite_username").val().trim();var t=$("#username_container");var n=t.find(".error_message");var a=TS.signup.checkUsernameSyntax(i);var r;if(!a.is_valid){n.html(a.error_message);t.addClass("error");r=a.error_message}if(r){n.html(a.error_message);t.addClass("error");s=false}return a.is_valid};var re=function e(i){i=i||$("#invite_username").val().trim();return TS.signup.checkUsernameAvailability(i,{team_id:TS.web.invite.team_id}).then(function(e){if(!e.is_valid){var i=$("#username_container");i.find(".error_message").html(e.error_message);i.addClass("error")}s=e.is_valid})};var se=function e(i,t){var n=i.val();var a=f||($("#invite_username").length?$("#invite_username").val():"");var r=TS.web.invite.email;t=t||$("");var s=t.find(".error_message");var o={username:a,email:r};return TS.utility.password.validate(n,o).then(function(e){if(!e.is_valid){t.addClass("error");s.html(e.error_message)}else{p=n}v=e.is_valid;return Promise.resolve(e)})};var oe=function e(){if(r==="revoked"||r==="accepted"||r==="invalid"){window.location=window.location}return Promise.resolve()};var le={shared_invite_email:G,name:E,password:U,sso:B,user_tos:D,guest_user_role:A,error:oe,single_page:x}})()}},[3923]);