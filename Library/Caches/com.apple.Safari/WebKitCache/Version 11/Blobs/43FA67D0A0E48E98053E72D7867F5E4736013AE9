webpackJsonp([408],{3873:function(e,i){(function(){"use strict";TS.registerModule("highlights_briefing",{sli_recaps_debug_group:null,updated_sig:new signals.Signal,$briefing_header:null,$briefing_view:null,last_request_id:null,last_cached_request_id:undefined,onStart:function e(){if(!TS.client)return;TS.client.ui.unread.started_sig.add(l);TS.client.unread.switched_away_sig.add(v);TS.channels.switched_sig.add(j);TS.groups.switched_sig.add(j);TS.mpims.switched_sig.add(j);TS.ims.switched_sig.add(j);TS.client.threads.switched_sig.add(x);TS.channels.marked_sig.add(D);TS.groups.marked_sig.add(D);TS.channels.message_changed_sig.add(W);TS.groups.message_changed_sig.add(W);TS.channels.message_removed_sig.add(J);TS.groups.message_removed_sig.add(J);TS.pins.pinned_status_changed_sig.add(G);TS.client.highlights.feedback_submitted_sig.add(H);TS.experiment.loadUserAssignments().then(function(){TS.highlights_briefing.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug")})},showBriefing:function i(){if(!TS.model.team.plan||!e||!n)return;e.removeClass("hidden");n.toggleClass("hidden",!s.expanded)},hideBriefing:function i(){if(!TS.model.team.plan||!e||!n)return;e.addClass("hidden");n.addClass("hidden")},clogBackButton:function e(){var i=_.get(s,["last_jump","model_ob_id"]);var t=_.get(s,["last_jump","ts"]);var n={channel_id:i,channel_type:i[0]||"",message_timestamp:t};var a;var r=TS.client.highlights.getHighlight(i,t);if(r){n.request_id=r.request_id;a=r.cached_request_id}if(a){n.cached_request_id=a}TS.clog.track("BRIEFING_BACK_TO_BRIEFING",n)},jumpToMessageInChannel:function e(i,t){O(i,t)},setUnreadPointOnMessage:function e(i){if(!TS.model.team.plan)return;i=String(i);var t=$('.sli_briefing__message ts-message[data-ts="'+i+'"]');if(t.length){var n=t.data("model-ob-id");TS.shared.markReadMsg(n,i,TS.model.marked_reasons.back);TS.client.markLastReadsWithAPI();D(TS.shared.getModelObById(n))}},getMessageFromCache:function e(i,t){return _.get(a,[i,t],null)},promiseToGetBriefing:function e(){return TS.api.call("highlights.briefing")},showBriefingWithResponse:function e(i){g(i)}});var e=null;var i=null;var t=null;var n=null;var a={};var s={expanded:false,scroll_top:0,last_jump:{ts:null,model_ob_id:null},show_briefing_back_button:false,last_open_ts:null,loading:true};var r={};var d=3;var l=function e(){if(!TS.model.team.plan)return;if(s.show_briefing_back_button||_.get(s,["last_jump","model_ob_id"])){B()}s.briefing_opens_count=TS.storage.fetchBriefingOpensCount();s.loading=true;f();TS.client.ui.unread.ensureSliLinkBriefingsAndUnreads().then(function(){if(!TS.client.ui.unread.sliLinkBriefingsAndUnreads()){TS.highlights_briefing.promiseToGetBriefing().then(g)}})};var g=function e(i){Promise.resolve(i).then(o).then(c).catch(function(e){TS.error("A call to highlights.briefing failed:");TS.logError(e,"Highlights in All Unreads either failed to render or got an error from the API");m(null,0,false,true)});I()};var o=function e(i){var t={};if(_.get(i,"data.messages.length")){i.data.messages=_.map(i.data.messages,function(e){var i=e.channel_id;var n=TS.utility.msgs.processImsg(e,i);n.channel_id=i;n.cached_request_id=e.cached_request_id;var a={};a.show_recap=true;a.score=e.score;a.feedback_options=e.feedback_options;a.request_id=e.request_id;a.cached_request_id=e.cached_request_id;a.justification=e.justification;t[i]=t[i]||{};t[i][e.ts]=a;return n});TS.client.highlights.addHighlights(t)}return i};var f=function e(){$("#unread_msgs_div").before(TS.templates.sli_briefing({show_onboarding:s.briefing_opens_count<d}));$("#unread_msgs_scroller_div").prepend(TS.templates.sli_briefing_header())};var c=function d(l){var g=_.get(l,"data.messages[0].cached_request_id");var o=!_.isUndefined(g)&&(g===TS.highlights_briefing.last_request_id||g===TS.highlights_briefing.last_cached_request_id);TS.highlights_briefing.last_cached_request_id=g;TS.highlights_briefing.last_request_id=l.request_id;s.loading=false;if(s.last_open_ts!==null&&s.last_open_ts<Date.now()-10*1e3*60||!o){s.expanded=false}if(_.get(l,"data.messages.length")){var f=_.groupBy(l.data.messages,"channel_id");var c=_(f).map(function(e,i){var t=TS.shared.getModelObById(i);var n=TS.shared.getTypeForModelOb(t);var a=TS.templates.builders.buildStarWithTip(n,t);var s={channel:t,star:new Handlebars.SafeString(a),messages:_(e).map(u).compact().value()};if(!s.messages.length){return null}return s}).compact().value();if(c.length){b(l.data.messages);i.find(".sli_briefing_view__messages").html(TS.templates.sli_briefing_message_view({groups:c}))}}else{a={}}if(l.data.headline){r={header:TS.format.formatWithOptions(l.data.headline.header||"","",{no_linking:true}),subheader:TS.format.formatWithOptions(l.data.headline.subheader||"","",{no_linking:true})};p(l.data.headline.users)}else{r={header:"",subheader:""}}var h=T();if(!h&&TS.client.ui.unread.sliLinkBriefingsAndUnreads()){e.hide()}else if(s.expanded&&h){A(false)}else if(s.expanded&&!h){s.expanded=false;t.removeClass("hidden");i.addClass("hidden");n.addClass("hidden");m(null,0,true)}else{var v=C();m(v,T())}var S=_.get(s,["last_jump","model_ob_id"]);var k=_.get(s,["last_jump","ts"]);if(_.get(a,[S,k])){s.scroll_top=0;s.last_jump.ts=null;s.last_jump.model_ob_id=null}if(h){s.briefing_opens_count+=1;TS.storage.storeBriefingOpensCount(s.briefing_opens_count)}TS.highlights_briefing.updated_sig.dispatch()};var h=function e(i){var t=TS.shared.getModelObById(i.channel_id);var n=$(TS.templates.builders.msgs.buildHTML({msg:i,model_ob:t,enable_slack_action_links:true,container_id:"sli_briefing",prev_msg:null,briefing:true}));if(i.pinned_to&&i.pinned_to.length||_.get(i,"file.pinned_to.length"))n.removeClass("is_pinned");n.addClass("is_sli_briefing");return n[0].outerHTML};var u=function e(i){var t=TS.client.highlights.getHighlight(i.channel_id,i.ts);if(t.feedback&&t.feedback!=="positive")return null;var n=y(t.feedback);var a=_.map(t.feedback_options.negative,function(e){return _.assign({},e,{text:new Handlebars.SafeString(TS.format.formatWithOptions(e.text,null,{no_linking:true}))})});return{message_markup:h(i),message:i,justification:t.justification,feedback_class:n,negative_feedback_options:a}};var m=function e(i,n,a,r){if(i&&n){t.removeClass("sli_briefing_preview--loading").addClass("sli_briefing_preview--has_briefings");t.find('[data-js="sli_briefing_preview_title"]').html(i.header);if(s.briefing_opens_count>=d)t.find('[data-js="sli_briefing_preview_description"]').html(i.subheader);t.find('[data-js="sli_briefing_preview_action"]').removeClass("hidden");if(s.briefing_opens_count>=d)t.find('[data-js="sli_briefing_preview_facepile"]').removeClass("hidden")}else if(a){t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("Done and done","highlights")());t.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("That’s it for the highlights! The rest of your unreads are below.","highlights")());t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden");t.find('[data-js="sli_briefing_preview_facepile"]').addClass("hidden")}else if(!r){t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("No new highlights","highlights")());t.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("But we’ll keep an ear to the ground.","highlights")());t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}else{t.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");t.find('[data-js="sli_briefing_preview_title"]').removeClass("small_bottom_margin").addClass("error no_bottom_margin").text(TS.i18n.t("Couldn’t load highlights","highlights")());t.find('[data-js="sli_briefing_preview_description"]').addClass("hidden");t.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}TS.highlights_briefing.updated_sig.dispatch()};var p=function e(i){var n=_.map(i,function(e){var i=TS.members.getMemberById(e);return TS.templates.builders.makeMemberPreviewLinkImage(i,32,false,true,true,true)}).join("");t.find('[data-js="sli_briefing_preview_facepile"]').html(n)};var b=function e(i){a={};_.forEach(i,function(e){a[e.channel_id]=a[e.channel_id]||{};a[e.channel_id][e.ts]=e})};var v=function a(){if(!TS.model.team.plan)return;M();e=null;i=null;t=null;n=null;TS.highlights_briefing.$briefing_header=null;TS.highlights_briefing.$briefing_view=null;TS.highlights_briefing.last_request_id=null;r=null;s.last_open_ts=Date.now()};var T=function e(){return _.reduce(a,function(e,i,t){return e+S(t)},0)};var S=function e(i){return _.reduce(a[i],function(e,i){if(!w(i))return e;return e+1},0)};var k=function e(){return _(a).flatMap(function(e){return _.map(e,function(e){if(!w(e))return null;return e})}).compact().value()};var w=function e(i){var t=TS.client.highlights.getHighlight(i.channel_id,i.ts)||{};return!(i._removed||t.feedback==="dismiss"||t.left_feedback)};var C=function e(){return r};var y=function e(i){if(i==="negative")return"gave_negative_feedback";if(i==="positive")return"gave_positive_feedback";if(i==="dismiss")return"sli_briefing__feedback--dismiss";return""};var j=function e(){if(TS.model.active_cid===_.get(s,["last_jump","model_ob_id"])&&s.show_briefing_back_button){q()}else if(s.last_jump&&s.show_briefing_back_button){B()}};var x=function e(){if(!TS.model.team.plan)return;if(s.last_jump&&s.show_briefing_back_button){B()}};var q=function e(){$(".sli_briefing__channel_back_button").removeClass("hidden");$("#messages_unread_status").addClass("sli_briefing--has_back_button")};var B=function e(){$(".sli_briefing__channel_back_button").addClass("hidden");$("#messages_unread_status").removeClass("sli_briefing--has_back_button");s.show_briefing_back_button=false};var I=function r(){e=$("#sli_briefing");i=$("[data-js=sli_briefing_view]");t=$('[data-js="sli_briefing_preview_container"]');n=$('[data-js="sli_briefing_header"]');TS.highlights_briefing.$briefing_header=n;TS.highlights_briefing.$briefing_view=i;e.on("click",".sli_briefing__message ts-message, .sli_briefing_target",function(e){if(!$(e.target).is("ts-message, .message_content, .message_body, .message_content_header_left, .sli_briefing_target, .comment, .rxn_panel")&&!$(e.target).parents(".message_body").length||$(e.target).parents(".msg_inline_file_preview_toggler").length||$(e.target).is("a")&&$(e.target).closest(".message_body").length||$(e.target).closest(".attachment_media").length){return}var i=$(this).is("ts-message")?$(this):$(this).parents("ts-message");var t=""+i.data("ts");var n=""+i.data("model-ob-id");O(n,t)});e.on("click",".sli_briefing__channel_link .channel_link",function(e){var i=$(e.target).data("channel-id");if(i[0]==="G"){TS.groups.displayGroup({id:i})}});e.on("click",'[data-js="sli_briefing_preview"]',function(){if(s.loading)return;s.expanded=true;A(true);var e={request_id:TS.highlights_briefing.last_request_id};var i=_.keys(a)[0];var t=_.keys(_.get(a,[i]))[0];var n=TS.client.highlights.getHighlight(i,t);var r=n.cached_request_id;if(r){e.cached_request_id=r}TS.clog.track("BRIEFING_REVEAL",e);TS.highlights_briefing.updated_sig.dispatch()});n.off("click").on("click",'[data-js="sli_briefing_header_dismiss_all"]',function(){s.expanded=false;F();var e=k();var i=_.map(e,function(e){return{channel_id:e.channel_id,ts:e.ts}});TS.api.call("highlights.dismissAll",{request_id:TS.highlights_briefing.last_request_id,source:"briefing",messages:JSON.stringify(i)}).catch(function(e){TS.error(e)})});e.on("click",'[data-js="sli_briefing_feedback_item"] a',function(e){e.preventDefault();var i=($(e.target).closest(".sli_briefing__feedback_leavebehind").data("feedback-for-cache-id")||"").split("-");var t=Number($(e.target).closest("li").data("index"));var n=i[0];var a=i[1];TS.client.highlights.setNegativeFeedbackForHighlight(n,a,t,"briefing")});e.on("click","[data-feedback]",function(e){e.preventDefault();var i=$(e.target).data("feedback");var t=$(e.target).closest(".sli_briefing__message");var n=(t.data("cache-id")||"").split("-");var a=n[0];var s=n[1];TS.client.highlights.setDefaultFeedbackForHighlight(a,s,{feedback:i},"briefing");$("#ts_tip_float_floater .ts_tip_tip").text(TS.i18n.t("Thank you!","highlights")())})};var H=function e(i){if(!TS.model.unread_view_is_showing)return;_.each(i,function(e,i){_.each(e,function(e,t){if(a[i]&&a[i][t]){var n=$('[data-cache-id="'+i+"-"+t+'"]');if(n.length)E(n,i,t,e)}})})};var E=function e(i,t,n,a){if(a.feedback==="dismiss"||!a.is_leaving_feedback&&a.left_feedback){N(i,t,function(){if(R()){U()}})}else if(a.feedback==="negative"&&a.is_leaving_feedback){i.find("ts-message").addClass("hidden");i.addClass("gave_negative_feedback");i.find('[data-feedback="negative"]').addClass("sli_briefing__feedback_control--pulse");$('[data-feedback-for-cache-id="'+t+"-"+n+'"]').removeClass("hidden")}else if(a.feedback==="positive"){i.addClass("gave_positive_feedback");i.find('[data-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse")}};var A=function t(a){var s=e.outerHeight();var r=$('[data-js="sli_briefing_preview_container"]');var d=61;i.removeClass("hidden");n.removeClass("hidden");TS.client.ui.checkInlineImgsAndIframes("unread");if(a){r.css({height:0,"margin-top":(TS.environment.supports_sticky_position?-d:0)+"px"});var _=e.outerHeight();e.css({height:s,"padding-top":d+20+"px","margin-top":-d+"px"});e.animate({height:_+d},300,function(){e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?d+20+"px":""});i.find(".sli_briefing__channel, .sli_briefing_view__footer").each(function(e,i){setTimeout(function(){$(i).css("opacity",1)},100*e+200)});if(!TS.model.prefs.seen_highlights_warm_welcome){setTimeout(function(){TS.coachmark.start(TS.coachmarks.coachmarks.highlights_feedback,true)},800);TS.model.prefs.seen_highlights_warm_welcome=true;TS.prefs.setPrefByAPI({name:"seen_highlights_warm_welcome",value:true});TS.clog.track("PREF_USER_CLIENT_UPDATE",{updated_user_client_prefs:{seen_highlights_warm_welcome:"true"}})}TS.highlights_briefing.updated_sig.dispatch()})}else{r.css({transition:"none",height:0,"margin-top":(TS.environment.supports_sticky_position?-d:0)+"px"});n.css("transition","none");i.find(".sli_briefing__channel, .sli_briefing_view__footer").css("opacity",1);e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?d+20+"px":""})}r.addClass("go-away");n.addClass("expand");if(!a){setTimeout(function(){n.css("transition","");r.css("transition","")},0)}};var F=function t(){var a=$('[data-js="sli_briefing_preview_container"]');n.removeClass("expand").addClass("go-away");var s=e.outerHeight();i.css({opacity:0,"pointer-events":"none"});m(null,0,true);var r=166;e.css({height:s,"margin-top":TS.environment.supports_sticky_position?"-61px":""});e.animate({height:r},300,function(){TS.highlights_briefing.updated_sig.dispatch()});a.css({transition:"none",transform:"translateY(118px)"});setTimeout(function(){a.css({transition:"",transform:"translateY(0)",opacity:1,"pointer-events":""})},0)};var M=function i(){if(e)e.off("click");if(n)n.off("click")};var O=function e(i,t){var n;var a;var r=TS.client.highlights.getHighlight(i,t);n=r.request_id;a=r.cached_request_id;s.scroll_top=TS.client.ui.unread.$scroller.scrollTop();s.last_jump={ts:t,model_ob_id:i};s.show_briefing_back_button=true;TS.client.ui.tryToJump(i,t);var d={channel_id:i,channel_type:i[0]||"",message_timestamp:t,request_id:n};if(a){d.cached_request_id=a}TS.clog.track("BRIEFING_JUMP_TO_CHANNEL",d)};var N=function e(i,t,n){var a=S(t)===0;if(a){L(i.closest(".sli_briefing__channel"),n)}else{i.addClass(y("dismiss"));setTimeout(function(){i.css({transition:"margin-bottom 0.3s","margin-bottom":0});i.animate({height:0},300,function(){var e=i.parents('.sli_briefing__channel[data-channel-id="'+t+'"]');i.remove();if(P(t)){e.css({transition:"opacity 0.2s",opacity:.5});e.find(".sli_briefing__channel_link .star").css("pointer-events","none")}if(n)n()})},300)}};var L=function e(i,t){i.addClass("dismiss");setTimeout(function(){i.css({transition:"margin-bottom 0.3s","margin-bottom":0});i.animate({height:0},300,function(){i.remove();if(t)t()});if(!T())$(".sli_briefing_view__footer").css("opacity",0)},300)};var P=function e(i){return _.every(a[i],function(e,t){var n=TS.client.highlights.getHighlight(i,t);return!n||n.feedback==="dismiss"})};var R=function e(){return _.every(a,function(e,i){return _.every(a[i],function(e,t){var n=TS.client.highlights.getHighlight(i,t);if(!n)return true;return n.feedback==="dismiss"||n.left_feedback===true})})};var U=function i(){e.replaceWith(TS.templates.sli_briefing());n.addClass("hidden");I();m(null,0,true);s.expanded=false};var D=function e(i){if(!TS.model.team.plan)return;if(!TS.model.unread_view_is_showing)return;if(!i||!a||_.isEmpty(a)||!a[i.id])return;_.each(a[i.id],function(e,t){if(t<i.last_read&&!e._removed){TS.client.highlights.setDefaultFeedbackForHighlight(i.id,t,{feedback:"dismiss"},"briefing-mark-as-read")}})};var G=function e(i){if(!TS.model.team.plan)return;if(!TS.model.unread_view_is_showing)return;if(!i||!a||_.isEmpty(a)||!a[i.id])return;_.each(a[i.id],function(e,t){var n=$('.sli_briefing__message[data-cache-id="'+i.id+"-"+t+'"]');if(n.length){var a=n.find("ts-message");if(a.hasClass("is_pinned"))a.removeClass("is_pinned")}})};var W=function e(i,t,n){if(!TS.model.unread_view_is_showing)return;if(!TS.model.team.plan)return;if(!a||_.isEmpty(a)||!a[i.id]||!a[i.id][t.ts]||!(_.includes(n,"text")||_.includes(n,"reply_count"))){return}var s=_.assign({},t,{channel_id:i.id});a[i.id][t.ts]=s;var r=$('.sli_briefing__message[data-cache-id="'+i.id+"-"+t.ts+'"]');if(!r.length)return;var d=r.find("ts-message");d.replaceWith(h(s))};var J=function e(i,t){if(!TS.model.unread_view_is_showing)return;if(!TS.model.team.plan)return;if(!a||_.isEmpty(a)||!a[i.id]||!a[i.id][t.ts])return;TS.client.highlights.setDefaultFeedbackForHighlight(i.id,t.ts,{feedback:"dismiss"})}})()}},[3873]);